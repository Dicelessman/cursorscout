<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda Esploratore - CursorScout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="js/firebaseConfig.js"></script>
    <script type="module" src="js/auth.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-bold text-blue-600">CursorScout</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-gray-600 hover:text-gray-900">Dashboard</a>
                    <button id="logoutBtn" class="text-red-600 hover:text-red-800">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div id="loading" class="flex items-center justify-center min-h-screen">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
            </div>

            <div id="schedaContent" class="hidden">
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="nomeCompleto"></h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500" id="email"></p>
                        </div>
                        <div id="staffControls" class="hidden">
                            <button id="editBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Modifica
                            </button>
                            <button id="saveBtn" class="hidden inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Salva
                            </button>
                            <button id="cancelBtn" class="hidden inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Annulla
                            </button>
                        </div>
                    </div>

                    <!-- Dati Anagrafici -->
                    <div class="border-t border-gray-200">
                        <dl>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Data di Nascita</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span id="dataNascitaDisplay"></span>
                                    <input type="date" id="dataNascitaEdit" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Codice Fiscale</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span id="codiceFiscaleDisplay"></span>
                                    <input type="text" id="codiceFiscaleEdit" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </dd>
                            </div>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Indirizzo</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span id="indirizzoDisplay"></span>
                                    <input type="text" id="indirizzoEdit" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </dd>
                            </div>
                        </dl>
                    </div>

                    <!-- Contatti -->
                    <div class="border-t border-gray-200">
                        <h4 class="px-4 py-5 sm:px-6 text-lg font-medium text-gray-900">Contatti</h4>
                        <dl>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Genitore 1</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="genitore1Display"></div>
                                    <div id="genitore1Edit" class="hidden space-y-2">
                                        <input type="text" id="genitore1NomeEdit" placeholder="Nome" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <input type="email" id="genitore1EmailEdit" placeholder="Email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <input type="tel" id="genitore1NumeroEdit" placeholder="Numero" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="mt-2 space-x-2">
                                        <button class="text-blue-600 hover:text-blue-800" onclick="chiama('genitore1')">
                                            ðŸ“ž Chiama
                                        </button>
                                        <button class="text-green-600 hover:text-green-800" onclick="whatsapp('genitore1')">
                                            ðŸ’¬ WhatsApp
                                        </button>
                                    </div>
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Genitore 2</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="genitore2Display"></div>
                                    <div id="genitore2Edit" class="hidden space-y-2">
                                        <input type="text" id="genitore2NomeEdit" placeholder="Nome" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <input type="email" id="genitore2EmailEdit" placeholder="Email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <input type="tel" id="genitore2NumeroEdit" placeholder="Numero" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="mt-2 space-x-2">
                                        <button class="text-blue-600 hover:text-blue-800" onclick="chiama('genitore2')">
                                            ðŸ“ž Chiama
                                        </button>
                                        <button class="text-green-600 hover:text-green-800" onclick="whatsapp('genitore2')">
                                            ðŸ’¬ WhatsApp
                                        </button>
                                    </div>
                                </dd>
                            </div>
                        </dl>
                    </div>

                    <!-- Informazioni Sanitarie -->
                    <div class="border-t border-gray-200">
                        <h4 class="px-4 py-5 sm:px-6 text-lg font-medium text-gray-900">Informazioni Sanitarie</h4>
                        <dl>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Gruppo Sanguigno</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span id="gruppoSanguignoDisplay"></span>
                                    <select id="gruppoSanguignoEdit" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Seleziona gruppo sanguigno</option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                        <option value="0+">0+</option>
                                        <option value="0-">0-</option>
                                    </select>
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Intolleranze Alimentari</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span id="intolleranzeDisplay"></span>
                                    <textarea id="intolleranzeEdit" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea>
                                    <button class="mt-2 text-blue-600 hover:text-blue-800" onclick="copiaIntolleranze()">
                                        ðŸ“‹ Copia
                                    </button>
                                </dd>
                            </div>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Allergie</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span id="allergieDisplay"></span>
                                    <textarea id="allergieEdit" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea>
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Farmaci</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span id="farmaciDisplay"></span>
                                    <textarea id="farmaciEdit" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea>
                                </dd>
                            </div>
                        </dl>
                    </div>

                    <!-- Progressione Scout -->
                    <div class="border-t border-gray-200">
                        <h4 class="px-4 py-5 sm:px-6 text-lg font-medium text-gray-900">Progressione Scout</h4>
                        <dl>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Promessa</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span id="promessaDisplay"></span>
                                    <input type="date" id="promessaEdit" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Prima Traccia</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="primaTracciaDisplay"></div>
                                    <div id="primaTracciaEdit" class="hidden space-y-2">
                                        <input type="date" id="primaTracciaDataEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <input type="text" id="primaTracciaSfidaEdit" placeholder="Sfida" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </dd>
                            </div>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Seconda Traccia</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="secondaTracciaDisplay"></div>
                                    <div id="secondaTracciaEdit" class="hidden space-y-2">
                                        <input type="date" id="secondaTracciaDataEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <input type="text" id="secondaTracciaSfidaEdit" placeholder="Sfida" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Terza Traccia</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="terzaTracciaDisplay"></div>
                                    <div id="terzaTracciaEdit" class="hidden space-y-2">
                                        <input type="date" id="terzaTracciaDataEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <input type="text" id="terzaTracciaSfidaEdit" placeholder="Sfida" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </dd>
                            </div>
                        </dl>
                    </div>

                    <!-- SpecialitÃ  -->
                    <div class="border-t border-gray-200">
                        <h4 class="px-4 py-5 sm:px-6 text-lg font-medium text-gray-900">SpecialitÃ </h4>
                        <div class="px-4 py-5 sm:px-6">
                            <div id="specialitaList" class="space-y-4">
                                <!-- Le specialitÃ  verranno aggiunte dinamicamente -->
                            </div>
                            <button id="aggiungiSpecialitaBtn" class="hidden mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Aggiungi SpecialitÃ 
                            </button>
                        </div>
                    </div>

                    <!-- Eventi -->
                    <div class="border-t border-gray-200">
                        <h4 class="px-4 py-5 sm:px-6 text-lg font-medium text-gray-900">Eventi</h4>
                        <dl>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Campi Estivi</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="campiEstiviDisplay"></div>
                                    <div id="campiEstiviEdit" class="hidden space-y-4">
                                        <div class="grid grid-cols-2 gap-4">
                                            <input type="text" id="campoEstivo1LuogoEdit" placeholder="Luogo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="date" id="campoEstivo1AnnoEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <input type="text" id="campoEstivo2LuogoEdit" placeholder="Luogo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="date" id="campoEstivo2AnnoEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <input type="text" id="campoEstivo3LuogoEdit" placeholder="Luogo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="date" id="campoEstivo3AnnoEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <input type="text" id="campoEstivo4LuogoEdit" placeholder="Luogo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="date" id="campoEstivo4AnnoEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Tecnicamp</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="tecnicampDisplay"></div>
                                    <div id="tecnicampEdit" class="hidden space-y-4">
                                        <div class="grid grid-cols-3 gap-4">
                                            <input type="text" id="tecnicamp1LuogoEdit" placeholder="Luogo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="text" id="tecnicamp1CorsoEdit" placeholder="Corso" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="date" id="tecnicamp1AnnoEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div class="grid grid-cols-3 gap-4">
                                            <input type="text" id="tecnicamp2LuogoEdit" placeholder="Luogo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="text" id="tecnicamp2CorsoEdit" placeholder="Corso" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="date" id="tecnicamp2AnnoEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div class="grid grid-cols-3 gap-4">
                                            <input type="text" id="tecnicamp3LuogoEdit" placeholder="Luogo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="text" id="tecnicamp3CorsoEdit" placeholder="Corso" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="date" id="tecnicamp3AnnoEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div class="grid grid-cols-3 gap-4">
                                            <input type="text" id="tecnicamp4LuogoEdit" placeholder="Luogo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="text" id="tecnicamp4CorsoEdit" placeholder="Corso" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="date" id="tecnicamp4AnnoEdit" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </dd>
                            </div>
                        </dl>
                    </div>

                    <!-- Documenti -->
                    <div class="border-t border-gray-200">
                        <h4 class="px-4 py-5 sm:px-6 text-lg font-medium text-gray-900">Documenti</h4>
                        <dl>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Quota Annuale</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="quotaAnnualeDisplay"></div>
                                    <div id="quotaAnnualeEdit" class="hidden space-y-4">
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="quotaAnnuale1DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="quotaAnnuale1CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="quotaAnnuale2DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="quotaAnnuale2CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="quotaAnnuale3DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="quotaAnnuale3CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="quotaAnnuale4DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="quotaAnnuale4CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                    </div>
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Modulo Iscrizione</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="moduloIscrizioneDisplay"></div>
                                    <div id="moduloIscrizioneEdit" class="hidden">
                                        <input type="checkbox" id="moduloIscrizioneCheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    </div>
                                </dd>
                            </div>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Modulo Sanitario</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="moduloSanitarioDisplay"></div>
                                    <div id="moduloSanitarioEdit" class="hidden space-y-4">
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="moduloSanitario1DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="moduloSanitario1CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="moduloSanitario2DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="moduloSanitario2CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="moduloSanitario3DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="moduloSanitario3CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="moduloSanitario4DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="moduloSanitario4CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                    </div>
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">Modulo Privacy</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <div id="moduloPrivacyDisplay"></div>
                                    <div id="moduloPrivacyEdit" class="hidden space-y-4">
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="moduloPrivacy1DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="moduloPrivacy1CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="moduloPrivacy2DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="moduloPrivacy2CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="moduloPrivacy3DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="moduloPrivacy3CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            <input type="date" id="moduloPrivacy4DataEdit" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <input type="checkbox" id="moduloPrivacy4CheckEdit" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                    </div>
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { auth } from './js/firebaseConfig.js';
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { db } from './js/firebaseConfig.js';

        const loading = document.getElementById('loading');
        const schedaContent = document.getElementById('schedaContent');
        const logoutBtn = document.getElementById('logoutBtn');
        const staffControls = document.getElementById('staffControls');
        const editBtn = document.getElementById('editBtn');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const aggiungiSpecialitaBtn = document.getElementById('aggiungiSpecialitaBtn');

        let currentUserData = null;
        let isStaff = false;
        let isEditing = false;

        // Funzioni di utilitÃ 
        window.chiama = (tipo) => {
            const numero = document.getElementById(`${tipo}Numero`).textContent;
            window.location.href = `tel:${numero}`;
        };

        window.whatsapp = (tipo) => {
            const numero = document.getElementById(`${tipo}Numero`).textContent;
            window.location.href = `https://wa.me/${numero}`;
        };

        window.copiaIntolleranze = () => {
            const intolleranze = document.getElementById('intolleranzeDisplay').textContent;
            navigator.clipboard.writeText(intolleranze);
        };

        // Funzioni per la gestione della modalitÃ  di modifica
        function enterEditMode() {
            isEditing = true;
            editBtn.classList.add('hidden');
            saveBtn.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');
            aggiungiSpecialitaBtn.classList.remove('hidden');

            // Mostra tutti i campi di modifica
            document.querySelectorAll('[id$="Edit"]').forEach(el => {
                if (el.id !== 'editBtn' && el.id !== 'saveBtn' && el.id !== 'cancelBtn') {
                    el.classList.remove('hidden');
                }
            });

            // Nascondi tutti i campi di visualizzazione
            document.querySelectorAll('[id$="Display"]').forEach(el => {
                el.classList.add('hidden');
            });
        }

        function exitEditMode() {
            isEditing = false;
            editBtn.classList.remove('hidden');
            saveBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            aggiungiSpecialitaBtn.classList.add('hidden');

            // Nascondi tutti i campi di modifica
            document.querySelectorAll('[id$="Edit"]').forEach(el => {
                if (el.id !== 'editBtn' && el.id !== 'saveBtn' && el.id !== 'cancelBtn') {
                    el.classList.add('hidden');
                }
            });

            // Mostra tutti i campi di visualizzazione
            document.querySelectorAll('[id$="Display"]').forEach(el => {
                el.classList.remove('hidden');
            });

            // Ripristina i valori originali
            populateDisplayFields(currentUserData);
        }

        // Funzioni per il popolamento dei campi
        function populateDisplayFields(userData) {
            // Dati anagrafici
            document.getElementById('dataNascitaDisplay').textContent = userData.datiScheda?.anagrafici?.dataNascita || '-';
            document.getElementById('codiceFiscaleDisplay').textContent = userData.datiScheda?.anagrafici?.codiceFiscale || '-';
            document.getElementById('indirizzoDisplay').textContent = userData.datiScheda?.anagrafici?.indirizzo || '-';

            // Contatti
            const genitore1 = userData.datiScheda?.contatti?.genitore1;
            const genitore2 = userData.datiScheda?.contatti?.genitore2;

            document.getElementById('genitore1Display').innerHTML = genitore1 ? `
                <div>Nome: ${genitore1.nome || '-'}</div>
                <div>Email: ${genitore1.email || '-'}</div>
                <div id="genitore1Numero">Numero: ${genitore1.numero || '-'}</div>
            ` : 'Nessun dato disponibile';

            document.getElementById('genitore2Display').innerHTML = genitore2 ? `
                <div>Nome: ${genitore2.nome || '-'}</div>
                <div>Email: ${genitore2.email || '-'}</div>
                <div id="genitore2Numero">Numero: ${genitore2.numero || '-'}</div>
            ` : 'Nessun dato disponibile';

            // Informazioni sanitarie
            document.getElementById('gruppoSanguignoDisplay').textContent = userData.datiScheda?.sanitarie?.gruppoSanguigno || '-';
            document.getElementById('intolleranzeDisplay').textContent = userData.datiScheda?.sanitarie?.intolleranze || '-';
            document.getElementById('allergieDisplay').textContent = userData.datiScheda?.sanitarie?.allergie || '-';
            document.getElementById('farmaciDisplay').textContent = userData.datiScheda?.sanitarie?.farmaci || '-';

            // Progressione scout
            document.getElementById('promessaDisplay').textContent = userData.datiScheda?.progressione?.promessa || '-';
            
            const primaTraccia = userData.datiScheda?.progressione?.primaTraccia;
            document.getElementById('primaTracciaDisplay').innerHTML = primaTraccia ? `
                <div>Data: ${primaTraccia.data || '-'}</div>
                <div>Sfida: ${primaTraccia.sfida || '-'}</div>
            ` : 'Nessun dato disponibile';

            const secondaTraccia = userData.datiScheda?.progressione?.secondaTraccia;
            document.getElementById('secondaTracciaDisplay').innerHTML = secondaTraccia ? `
                <div>Data: ${secondaTraccia.data || '-'}</div>
                <div>Sfida: ${secondaTraccia.sfida || '-'}</div>
            ` : 'Nessun dato disponibile';

            const terzaTraccia = userData.datiScheda?.progressione?.terzaTraccia;
            document.getElementById('terzaTracciaDisplay').innerHTML = terzaTraccia ? `
                <div>Data: ${terzaTraccia.data || '-'}</div>
                <div>Sfida: ${terzaTraccia.sfida || '-'}</div>
            ` : 'Nessun dato disponibile';

            // Eventi
            const campiEstivi = userData.datiScheda?.eventi?.campiEstivi;
            document.getElementById('campiEstiviDisplay').innerHTML = campiEstivi ? `
                <div>Campo 1: ${campiEstivi[1]?.luogo || '-'} (${campiEstivi[1]?.anno || '-'})</div>
                <div>Campo 2: ${campiEstivi[2]?.luogo || '-'} (${campiEstivi[2]?.anno || '-'})</div>
                <div>Campo 3: ${campiEstivi[3]?.luogo || '-'} (${campiEstivi[3]?.anno || '-'})</div>
                <div>Campo 4: ${campiEstivi[4]?.luogo || '-'} (${campiEstivi[4]?.anno || '-'})</div>
            ` : 'Nessun dato disponibile';

            const tecnicamp = userData.datiScheda?.eventi?.tecnicamp;
            document.getElementById('tecnicampDisplay').innerHTML = tecnicamp ? `
                <div>Tecnicamp 1: ${tecnicamp[1]?.luogo || '-'} - ${tecnicamp[1]?.corso || '-'} (${tecnicamp[1]?.anno || '-'})</div>
                <div>Tecnicamp 2: ${tecnicamp[2]?.luogo || '-'} - ${tecnicamp[2]?.corso || '-'} (${tecnicamp[2]?.anno || '-'})</div>
                <div>Tecnicamp 3: ${tecnicamp[3]?.luogo || '-'} - ${tecnicamp[3]?.corso || '-'} (${tecnicamp[3]?.anno || '-'})</div>
                <div>Tecnicamp 4: ${tecnicamp[4]?.luogo || '-'} - ${tecnicamp[4]?.corso || '-'} (${tecnicamp[4]?.anno || '-'})</div>
            ` : 'Nessun dato disponibile';

            // Documenti
            const quotaAnnuale = userData.datiScheda?.documenti?.quotaAnnuale;
            document.getElementById('quotaAnnualeDisplay').innerHTML = quotaAnnuale ? `
                <div>Quota 1: ${quotaAnnuale[1]?.data || '-'} ${quotaAnnuale[1]?.pagata ? 'âœ“' : 'âœ—'}</div>
                <div>Quota 2: ${quotaAnnuale[2]?.data || '-'} ${quotaAnnuale[2]?.pagata ? 'âœ“' : 'âœ—'}</div>
                <div>Quota 3: ${quotaAnnuale[3]?.data || '-'} ${quotaAnnuale[3]?.pagata ? 'âœ“' : 'âœ—'}</div>
                <div>Quota 4: ${quotaAnnuale[4]?.data || '-'} ${quotaAnnuale[4]?.pagata ? 'âœ“' : 'âœ—'}</div>
            ` : 'Nessun dato disponibile';

            const moduloIscrizione = userData.datiScheda?.documenti?.moduloIscrizione;
            document.getElementById('moduloIscrizioneDisplay').innerHTML = moduloIscrizione ? `
                <div>Modulo Iscrizione: ${moduloIscrizione.presente ? 'âœ“' : 'âœ—'}</div>
            ` : 'Nessun dato disponibile';

            const moduloSanitario = userData.datiScheda?.documenti?.moduloSanitario;
            document.getElementById('moduloSanitarioDisplay').innerHTML = moduloSanitario ? `
                <div>Modulo 1: ${moduloSanitario[1]?.data || '-'} ${moduloSanitario[1]?.presente ? 'âœ“' : 'âœ—'}</div>
                <div>Modulo 2: ${moduloSanitario[2]?.data || '-'} ${moduloSanitario[2]?.presente ? 'âœ“' : 'âœ—'}</div>
                <div>Modulo 3: ${moduloSanitario[3]?.data || '-'} ${moduloSanitario[3]?.presente ? 'âœ“' : 'âœ—'}</div>
                <div>Modulo 4: ${moduloSanitario[4]?.data || '-'} ${moduloSanitario[4]?.presente ? 'âœ“' : 'âœ—'}</div>
            ` : 'Nessun dato disponibile';

            const moduloPrivacy = userData.datiScheda?.documenti?.moduloPrivacy;
            document.getElementById('moduloPrivacyDisplay').innerHTML = moduloPrivacy ? `
                <div>Modulo 1: ${moduloPrivacy[1]?.data || '-'} ${moduloPrivacy[1]?.presente ? 'âœ“' : 'âœ—'}</div>
                <div>Modulo 2: ${moduloPrivacy[2]?.data || '-'} ${moduloPrivacy[2]?.presente ? 'âœ“' : 'âœ—'}</div>
                <div>Modulo 3: ${moduloPrivacy[3]?.data || '-'} ${moduloPrivacy[3]?.presente ? 'âœ“' : 'âœ—'}</div>
                <div>Modulo 4: ${moduloPrivacy[4]?.data || '-'} ${moduloPrivacy[4]?.presente ? 'âœ“' : 'âœ—'}</div>
            ` : 'Nessun dato disponibile';
        }

        function populateEditFields(userData) {
            // Dati anagrafici
            document.getElementById('dataNascitaEdit').value = userData.datiScheda?.anagrafici?.dataNascita || '';
            document.getElementById('codiceFiscaleEdit').value = userData.datiScheda?.anagrafici?.codiceFiscale || '';
            document.getElementById('indirizzoEdit').value = userData.datiScheda?.anagrafici?.indirizzo || '';

            // Contatti
            const genitore1 = userData.datiScheda?.contatti?.genitore1;
            const genitore2 = userData.datiScheda?.contatti?.genitore2;

            document.getElementById('genitore1NomeEdit').value = genitore1?.nome || '';
            document.getElementById('genitore1EmailEdit').value = genitore1?.email || '';
            document.getElementById('genitore1NumeroEdit').value = genitore1?.numero || '';

            document.getElementById('genitore2NomeEdit').value = genitore2?.nome || '';
            document.getElementById('genitore2EmailEdit').value = genitore2?.email || '';
            document.getElementById('genitore2NumeroEdit').value = genitore2?.numero || '';

            // Informazioni sanitarie
            document.getElementById('gruppoSanguignoEdit').value = userData.datiScheda?.sanitarie?.gruppoSanguigno || '';
            document.getElementById('intolleranzeEdit').value = userData.datiScheda?.sanitarie?.intolleranze || '';
            document.getElementById('allergieEdit').value = userData.datiScheda?.sanitarie?.allergie || '';
            document.getElementById('farmaciEdit').value = userData.datiScheda?.sanitarie?.farmaci || '';

            // Progressione scout
            document.getElementById('promessaEdit').value = userData.datiScheda?.progressione?.promessa || '';
            
            const primaTraccia = userData.datiScheda?.progressione?.primaTraccia;
            document.getElementById('primaTracciaDataEdit').value = primaTraccia?.data || '';
            document.getElementById('primaTracciaSfidaEdit').value = primaTraccia?.sfida || '';

            const secondaTraccia = userData.datiScheda?.progressione?.secondaTraccia;
            document.getElementById('secondaTracciaDataEdit').value = secondaTraccia?.data || '';
            document.getElementById('secondaTracciaSfidaEdit').value = secondaTraccia?.sfida || '';

            const terzaTraccia = userData.datiScheda?.progressione?.terzaTraccia;
            document.getElementById('terzaTracciaDataEdit').value = terzaTraccia?.data || '';
            document.getElementById('terzaTracciaSfidaEdit').value = terzaTraccia?.sfida || '';

            // Eventi
            const campiEstivi = userData.datiScheda?.eventi?.campiEstivi;
            document.getElementById('campoEstivo1LuogoEdit').value = campiEstivi?.[1]?.luogo || '';
            document.getElementById('campoEstivo1AnnoEdit').value = campiEstivi?.[1]?.anno || '';
            document.getElementById('campoEstivo2LuogoEdit').value = campiEstivi?.[2]?.luogo || '';
            document.getElementById('campoEstivo2AnnoEdit').value = campiEstivi?.[2]?.anno || '';
            document.getElementById('campoEstivo3LuogoEdit').value = campiEstivi?.[3]?.luogo || '';
            document.getElementById('campoEstivo3AnnoEdit').value = campiEstivi?.[3]?.anno || '';
            document.getElementById('campoEstivo4LuogoEdit').value = campiEstivi?.[4]?.luogo || '';
            document.getElementById('campoEstivo4AnnoEdit').value = campiEstivi?.[4]?.anno || '';

            const tecnicamp = userData.datiScheda?.eventi?.tecnicamp;
            document.getElementById('tecnicamp1LuogoEdit').value = tecnicamp?.[1]?.luogo || '';
            document.getElementById('tecnicamp1CorsoEdit').value = tecnicamp?.[1]?.corso || '';
            document.getElementById('tecnicamp1AnnoEdit').value = tecnicamp?.[1]?.anno || '';
            document.getElementById('tecnicamp2LuogoEdit').value = tecnicamp?.[2]?.luogo || '';
            document.getElementById('tecnicamp2CorsoEdit').value = tecnicamp?.[2]?.corso || '';
            document.getElementById('tecnicamp2AnnoEdit').value = tecnicamp?.[2]?.anno || '';
            document.getElementById('tecnicamp3LuogoEdit').value = tecnicamp?.[3]?.luogo || '';
            document.getElementById('tecnicamp3CorsoEdit').value = tecnicamp?.[3]?.corso || '';
            document.getElementById('tecnicamp3AnnoEdit').value = tecnicamp?.[3]?.anno || '';
            document.getElementById('tecnicamp4LuogoEdit').value = tecnicamp?.[4]?.luogo || '';
            document.getElementById('tecnicamp4CorsoEdit').value = tecnicamp?.[4]?.corso || '';
            document.getElementById('tecnicamp4AnnoEdit').value = tecnicamp?.[4]?.anno || '';

            // Documenti
            const quotaAnnuale = userData.datiScheda?.documenti?.quotaAnnuale;
            const moduloIscrizione = userData.datiScheda?.documenti?.moduloIscrizione;
            const moduloSanitario = userData.datiScheda?.documenti?.moduloSanitario;
            const moduloPrivacy = userData.datiScheda?.documenti?.moduloPrivacy;

            document.getElementById('quotaAnnuale1DataEdit').value = quotaAnnuale?.[1]?.data || '';
            document.getElementById('quotaAnnuale1CheckEdit').checked = quotaAnnuale?.[1]?.pagata || false;
            document.getElementById('quotaAnnuale2DataEdit').value = quotaAnnuale?.[2]?.data || '';
            document.getElementById('quotaAnnuale2CheckEdit').checked = quotaAnnuale?.[2]?.pagata || false;
            document.getElementById('quotaAnnuale3DataEdit').value = quotaAnnuale?.[3]?.data || '';
            document.getElementById('quotaAnnuale3CheckEdit').checked = quotaAnnuale?.[3]?.pagata || false;
            document.getElementById('quotaAnnuale4DataEdit').value = quotaAnnuale?.[4]?.data || '';
            document.getElementById('quotaAnnuale4CheckEdit').checked = quotaAnnuale?.[4]?.pagata || false;

            document.getElementById('moduloIscrizioneCheckEdit').checked = moduloIscrizione?.presente || false;

            document.getElementById('moduloSanitario1DataEdit').value = moduloSanitario?.[1]?.data || '';
            document.getElementById('moduloSanitario1CheckEdit').checked = moduloSanitario?.[1]?.presente || false;
            document.getElementById('moduloSanitario2DataEdit').value = moduloSanitario?.[2]?.data || '';
            document.getElementById('moduloSanitario2CheckEdit').checked = moduloSanitario?.[2]?.presente || false;
            document.getElementById('moduloSanitario3DataEdit').value = moduloSanitario?.[3]?.data || '';
            document.getElementById('moduloSanitario3CheckEdit').checked = moduloSanitario?.[3]?.presente || false;
            document.getElementById('moduloSanitario4DataEdit').value = moduloSanitario?.[4]?.data || '';
            document.getElementById('moduloSanitario4CheckEdit').checked = moduloSanitario?.[4]?.presente || false;

            document.getElementById('moduloPrivacy1DataEdit').value = moduloPrivacy?.[1]?.data || '';
            document.getElementById('moduloPrivacy1CheckEdit').checked = moduloPrivacy?.[1]?.presente || false;
            document.getElementById('moduloPrivacy2DataEdit').value = moduloPrivacy?.[2]?.data || '';
            document.getElementById('moduloPrivacy2CheckEdit').checked = moduloPrivacy?.[2]?.presente || false;
            document.getElementById('moduloPrivacy3DataEdit').value = moduloPrivacy?.[3]?.data || '';
            document.getElementById('moduloPrivacy3CheckEdit').checked = moduloPrivacy?.[3]?.presente || false;
            document.getElementById('moduloPrivacy4DataEdit').value = moduloPrivacy?.[4]?.data || '';
            document.getElementById('moduloPrivacy4CheckEdit').checked = moduloPrivacy?.[4]?.presente || false;
        }

        // Funzione per salvare i dati
        async function saveData(userId) {
            const userData = {
                datiScheda: {
                    anagrafici: {
                        dataNascita: document.getElementById('dataNascitaEdit').value,
                        codiceFiscale: document.getElementById('codiceFiscaleEdit').value,
                        indirizzo: document.getElementById('indirizzoEdit').value
                    },
                    contatti: {
                        genitore1: {
                            nome: document.getElementById('genitore1NomeEdit').value,
                            email: document.getElementById('genitore1EmailEdit').value,
                            numero: document.getElementById('genitore1NumeroEdit').value
                        },
                        genitore2: {
                            nome: document.getElementById('genitore2NomeEdit').value,
                            email: document.getElementById('genitore2EmailEdit').value,
                            numero: document.getElementById('genitore2NumeroEdit').value
                        }
                    },
                    sanitarie: {
                        gruppoSanguigno: document.getElementById('gruppoSanguignoEdit').value,
                        intolleranze: document.getElementById('intolleranzeEdit').value,
                        allergie: document.getElementById('allergieEdit').value,
                        farmaci: document.getElementById('farmaciEdit').value
                    },
                    progressione: {
                        promessa: document.getElementById('promessaEdit').value,
                        primaTraccia: {
                            data: document.getElementById('primaTracciaDataEdit').value,
                            sfida: document.getElementById('primaTracciaSfidaEdit').value
                        },
                        secondaTraccia: {
                            data: document.getElementById('secondaTracciaDataEdit').value,
                            sfida: document.getElementById('secondaTracciaSfidaEdit').value
                        },
                        terzaTraccia: {
                            data: document.getElementById('terzaTracciaDataEdit').value,
                            sfida: document.getElementById('terzaTracciaSfidaEdit').value
                        }
                    },
                    eventi: {
                        campiEstivi: {
                            1: {
                                luogo: document.getElementById('campoEstivo1LuogoEdit').value,
                                anno: document.getElementById('campoEstivo1AnnoEdit').value
                            },
                            2: {
                                luogo: document.getElementById('campoEstivo2LuogoEdit').value,
                                anno: document.getElementById('campoEstivo2AnnoEdit').value
                            },
                            3: {
                                luogo: document.getElementById('campoEstivo3LuogoEdit').value,
                                anno: document.getElementById('campoEstivo3AnnoEdit').value
                            },
                            4: {
                                luogo: document.getElementById('campoEstivo4LuogoEdit').value,
                                anno: document.getElementById('campoEstivo4AnnoEdit').value
                            }
                        },
                        tecnicamp: {
                            1: {
                                luogo: document.getElementById('tecnicamp1LuogoEdit').value,
                                corso: document.getElementById('tecnicamp1CorsoEdit').value,
                                anno: document.getElementById('tecnicamp1AnnoEdit').value
                            },
                            2: {
                                luogo: document.getElementById('tecnicamp2LuogoEdit').value,
                                corso: document.getElementById('tecnicamp2CorsoEdit').value,
                                anno: document.getElementById('tecnicamp2AnnoEdit').value
                            },
                            3: {
                                luogo: document.getElementById('tecnicamp3LuogoEdit').value,
                                corso: document.getElementById('tecnicamp3CorsoEdit').value,
                                anno: document.getElementById('tecnicamp3AnnoEdit').value
                            },
                            4: {
                                luogo: document.getElementById('tecnicamp4LuogoEdit').value,
                                corso: document.getElementById('tecnicamp4CorsoEdit').value,
                                anno: document.getElementById('tecnicamp4AnnoEdit').value
                            }
                        }
                    },
                    documenti: {
                        quotaAnnuale: {
                            1: {
                                data: document.getElementById('quotaAnnuale1DataEdit').value,
                                pagata: document.getElementById('quotaAnnuale1CheckEdit').checked
                            },
                            2: {
                                data: document.getElementById('quotaAnnuale2DataEdit').value,
                                pagata: document.getElementById('quotaAnnuale2CheckEdit').checked
                            },
                            3: {
                                data: document.getElementById('quotaAnnuale3DataEdit').value,
                                pagata: document.getElementById('quotaAnnuale3CheckEdit').checked
                            },
                            4: {
                                data: document.getElementById('quotaAnnuale4DataEdit').value,
                                pagata: document.getElementById('quotaAnnuale4CheckEdit').checked
                            }
                        },
                        moduloIscrizione: {
                            presente: document.getElementById('moduloIscrizioneCheckEdit').checked
                        },
                        moduloSanitario: {
                            1: {
                                data: document.getElementById('moduloSanitario1DataEdit').value,
                                presente: document.getElementById('moduloSanitario1CheckEdit').checked
                            },
                            2: {
                                data: document.getElementById('moduloSanitario2DataEdit').value,
                                presente: document.getElementById('moduloSanitario2CheckEdit').checked
                            },
                            3: {
                                data: document.getElementById('moduloSanitario3DataEdit').value,
                                presente: document.getElementById('moduloSanitario3CheckEdit').checked
                            },
                            4: {
                                data: document.getElementById('moduloSanitario4DataEdit').value,
                                presente: document.getElementById('moduloSanitario4CheckEdit').checked
                            }
                        },
                        moduloPrivacy: {
                            1: {
                                data: document.getElementById('moduloPrivacy1DataEdit').value,
                                presente: document.getElementById('moduloPrivacy1CheckEdit').checked
                            },
                            2: {
                                data: document.getElementById('moduloPrivacy2DataEdit').value,
                                presente: document.getElementById('moduloPrivacy2CheckEdit').checked
                            },
                            3: {
                                data: document.getElementById('moduloPrivacy3DataEdit').value,
                                presente: document.getElementById('moduloPrivacy3CheckEdit').checked
                            },
                            4: {
                                data: document.getElementById('moduloPrivacy4DataEdit').value,
                                presente: document.getElementById('moduloPrivacy4CheckEdit').checked
                            }
                        }
                    }
                }
            };

            try {
                await updateDoc(doc(db, "utenti", userId), userData);
                currentUserData = { ...currentUserData, ...userData };
                exitEditMode();
                populateDisplayFields(currentUserData);
            } catch (error) {
                console.error("Errore durante il salvataggio:", error);
                alert("Si Ã¨ verificato un errore durante il salvataggio dei dati.");
            }
        }

        // Event listeners
        editBtn.addEventListener('click', enterEditMode);
        saveBtn.addEventListener('click', () => saveData(currentUserData.uid));
        cancelBtn.addEventListener('click', exitEditMode);

        // Verifica autenticazione e carica dati
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id') || user.uid;

            try {
                const userDoc = await getDoc(doc(db, "utenti", userId));
                if (!userDoc.exists()) {
                    throw new Error('Utente non trovato');
                }

                const userData = userDoc.data();
                currentUserData = { ...userData, uid: userId };

                // Verifica se l'utente corrente Ã¨ staff
                const currentUserDoc = await getDoc(doc(db, "utenti", user.uid));
                const loggedInUserData = currentUserDoc.data();
                isStaff = loggedInUserData.staff && loggedInUserData.approvato;

                // Mostra i controlli staff solo se l'utente Ã¨ staff
                if (isStaff) {
                    staffControls.classList.remove('hidden');
                }

                // Popola i dati della scheda
                document.getElementById('nomeCompleto').textContent = `${userData.nome} ${userData.cognome}`;
                document.getElementById('email').textContent = userData.email;

                // Popola i campi di visualizzazione
                populateDisplayFields(userData);

                // Popola i campi di modifica
                populateEditFields(userData);

                // Nascondi il loading e mostra il contenuto
                loading.classList.add('hidden');
                schedaContent.classList.remove('hidden');
            } catch (error) {
                console.error("Errore durante il caricamento:", error);
                alert("Si Ã¨ verificato un errore durante il caricamento dei dati.");
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Errore durante il logout:", error);
            }
        });
    </script>
</body>
</html> 